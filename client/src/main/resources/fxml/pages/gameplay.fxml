<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.image.ImageView?>
<?import javafx.scene.layout.*?>
<?import org.kordamp.ikonli.javafx.FontIcon?>

<StackPane xmlns="http://javafx.com/javafx/21"
           xmlns:fx="http://javafx.com/fxml/1"
           fx:controller="com.mathspeed.controller.GameplayController"
           prefHeight="700.0"
           prefWidth="480.0">

    <VBox styleClass="gameplay-view"
          stylesheets="@../../css/gameplay.css"
          spacing="5.0"
          alignment="TOP_CENTER"
          maxWidth="900.0"
          VBox.vgrow="ALWAYS">

        <!-- Header -->
        <HBox spacing="20.0" alignment="CENTER" styleClass="gameplay-header">
            <padding>
                <Insets top="5.0" right="10.0" bottom="5.0" left="10.0"/>
            </padding>

            <!-- Player -->
            <VBox alignment="CENTER" spacing="4.0" styleClass="score-container">
                <ImageView fx:id="playerAvatarImage"
                           fitWidth="50.0" fitHeight="50.0"
                           pickOnBounds="true"
                           preserveRatio="true"
                           styleClass="avatar-image"/>
                <Label fx:id="playerNameLabel" text="You" styleClass="player-label"/>
                <Label fx:id="playerScoreLabel" text="0" styleClass="score-text"/>
            </VBox>

            <!-- Timer -->
            <VBox alignment="CENTER" spacing="1.0" styleClass="timer-container">
                <HBox alignment="CENTER" spacing="4.0">
                    <FontIcon iconLiteral="fas-hourglass-end" styleClass="timer-icon"/>
                    <Label fx:id="timerLabel" text="30s" styleClass="timer-text"/>
                </HBox>
            </VBox>

            <!-- Opponent -->
            <VBox alignment="CENTER" spacing="4.0" styleClass="score-container">
                <ImageView fx:id="opponentAvatarImage"
                           fitWidth="50.0" fitHeight="50.0"
                           pickOnBounds="true"
                           preserveRatio="true"
                           styleClass="avatar-image"/>
                <Label fx:id="opponentNameLabel" text="Opponent" styleClass="opponent-label"/>
                <Label fx:id="opponentScoreLabel" text="0" styleClass="score-text"/>
            </VBox>
        </HBox>

        <!-- Round Info -->
        <HBox spacing="15.0" alignment="CENTER" styleClass="game-info-container">
            <VBox.margin>
                <Insets top="2.0" right="10.0" left="10.0" bottom="2.0"/>
            </VBox.margin>

            <VBox alignment="CENTER" spacing="1.0" styleClass="round-container">
                <Label text="Câu số" styleClass="info-label"/>
                <Label fx:id="roundLabel" text="1 / 20" styleClass="round-text"/>
            </VBox>
        </HBox>

        <!-- Target Number -->
        <VBox spacing="4.0" alignment="CENTER">
            <VBox.margin>
                <Insets top="4.0" right="10.0" left="10.0" bottom="2.0"/>
            </VBox.margin>
            <Label text="Mục tiêu" styleClass="target-label"/>
            <Label fx:id="targetLabel" text="42" styleClass="target-number"/>
        </VBox>

        <!-- Game Status -->
        <VBox alignment="CENTER">
            <VBox.margin>
                <Insets top="2.0" right="10.0" left="10.0" bottom="2.0"/>
            </VBox.margin>
            <Label fx:id="gameStatusLabel"
                   text="Waiting for game to start..."
                   styleClass="game-status-text"
                   wrapText="true"
                   alignment="CENTER"
                   maxWidth="720.0"/>
        </VBox>

        <!-- Expression Input -->
        <VBox spacing="5.0" alignment="CENTER" styleClass="input-section">
            <VBox.margin>
                <Insets top="4.0" right="12.0" left="12.0" bottom="4.0"/>
            </VBox.margin>

            <VBox styleClass="expression-container" alignment="CENTER_LEFT" prefHeight="44.0" maxWidth="800.0">
                <padding>
                    <Insets top="6.0" right="10.0" bottom="6.0" left="10.0"/>
                </padding>
                <Label fx:id="expressionLabel"
                       text=""
                       styleClass="expression-text"
                       wrapText="true"
                       alignment="CENTER_LEFT"
                       maxWidth="800"/>
            </VBox>

            <!-- Buttons -->
            <HBox spacing="12.0" alignment="CENTER" styleClass="button-row">
                <Button fx:id="submitButton"
                        text="Nộp"
                        styleClass="submit-button"
                        prefWidth="100.0"
                        prefHeight="34.0"
                        onAction="#handleSubmit"/>

                <Button fx:id="exitButton"
                        text="Thoát"
                        styleClass="exit-button"
                        prefWidth="100.0"
                        prefHeight="34.0"
                        onAction="#handleExit"/>
            </HBox>
        </VBox>

        <!-- Operators -->
        <VBox spacing="5.0" alignment="CENTER">
            <VBox.margin>
                <Insets top="4.0" right="10.0" left="10.0" bottom="4.0"/>
            </VBox.margin>

            <HBox spacing="8.0" alignment="CENTER">
                <Button text="+" styleClass="operator-button" prefWidth="42.0" prefHeight="38.0" onAction="#handleOperatorInput"/>
                <Button text="-" styleClass="operator-button" prefWidth="42.0" prefHeight="38.0" onAction="#handleOperatorInput"/>
                <Button text="×" styleClass="operator-button" prefWidth="42.0" prefHeight="38.0" onAction="#handleOperatorInput"/>
                <Button text="÷" styleClass="operator-button" prefWidth="42.0" prefHeight="38.0" onAction="#handleOperatorInput"/>

                <Separator orientation="VERTICAL" styleClass="operator-separator"/>

                <Button text="(" styleClass="bracket-button" prefWidth="42.0" prefHeight="38.0" onAction="#handleBracketInput"/>
                <Button text=")" styleClass="bracket-button" prefWidth="42.0" prefHeight="38.0" onAction="#handleBracketInput"/>
            </HBox>
        </VBox>

        <!-- Numbers -->
        <VBox spacing="8.0" alignment="CENTER" VBox.vgrow="ALWAYS">
            <VBox.margin>
                <Insets top="6.0" right="10.0" left="10.0" bottom="15.0"/>
            </VBox.margin>

            <GridPane hgap="8.0" vgap="8.0" alignment="CENTER" styleClass="numbers-grid">
                <Button text="1" styleClass="number-button" GridPane.rowIndex="0" GridPane.columnIndex="0" onAction="#handleNumberInput"/>
                <Button text="2" styleClass="number-button" GridPane.rowIndex="0" GridPane.columnIndex="1" onAction="#handleNumberInput"/>
                <Button text="3" styleClass="number-button" GridPane.rowIndex="0" GridPane.columnIndex="2" onAction="#handleNumberInput"/>
                <Button text="4" styleClass="number-button" GridPane.rowIndex="0" GridPane.columnIndex="3" onAction="#handleNumberInput"/>
                <Button text="5" styleClass="number-button" GridPane.rowIndex="0" GridPane.columnIndex="4" onAction="#handleNumberInput"/>

                <Button text="6" styleClass="number-button" GridPane.rowIndex="1" GridPane.columnIndex="0" onAction="#handleNumberInput"/>
                <Button text="7" styleClass="number-button" GridPane.rowIndex="1" GridPane.columnIndex="1" onAction="#handleNumberInput"/>
                <Button text="8" styleClass="number-button" GridPane.rowIndex="1" GridPane.columnIndex="2" onAction="#handleNumberInput"/>
                <Button text="9" styleClass="number-button" GridPane.rowIndex="1" GridPane.columnIndex="3" onAction="#handleNumberInput"/>

                <Button fx:id="backspaceButton"
                        styleClass="backspace-button"
                        prefWidth="52.0"
                        prefHeight="52.0"
                        GridPane.rowIndex="1"
                        GridPane.columnIndex="4"
                        onAction="#handleBackspace">
                    <graphic>
                        <FontIcon iconLiteral="fas-backspace"/>
                    </graphic>
                </Button>
            </GridPane>
        </VBox>
    </VBox>

    <!-- Countdown Overlay -->
    <StackPane fx:id="countdownOverlay"
               styleClass="countdown-overlay"
               visible="false"
               managed="false"
               pickOnBounds="false"
               StackPane.alignment="CENTER">

        <VBox fx:id="countdownContainer"
              alignment="CENTER"
              spacing="20.0"
              styleClass="countdown-container">

            <Label fx:id="countdownMessageLabel"
                   text="Trận đấu sắp bắt đầu!"
                   styleClass="countdown-message"/>

            <Label fx:id="countdownLabel"
                   text="5"
                   styleClass="countdown-number"/>

        </VBox>
    </StackPane>

</StackPane>